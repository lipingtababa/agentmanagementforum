---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';

export async function getStaticPaths() {
  const authors = await getCollection('authors');
  const allArticles = await getCollection('articles');
  const authorMap = new Map(authors.map((a) => [a.id, a.data.name]));

  return authors.map((author) => ({
    params: { id: author.id },
    props: {
      author,
      articles: allArticles
        .filter((article) => article.data.author.id === author.id)
        .sort(
          (a, b) =>
            new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
        ),
      authorMap,
    },
  }));
}

const { author, articles, authorMap } = Astro.props;
const { name, bio, website, github, twitter } = author.data;
const { Content } = await render(author);
---

<BaseLayout
  title={`${name} | Agent Management Forum`}
  description={bio}
>
  <div class="mb-8">
    <h1 class="text-3xl font-bold tracking-tight text-[var(--color-text-primary)]">
      {name}
    </h1>
    <p class="mt-2 text-lg text-[var(--color-text-secondary)]">{bio}</p>
    <div class="mt-3 flex flex-wrap gap-4 text-sm">
      {website && (
        <a
          href={website}
          class="text-[var(--color-primary-600)] dark:text-[var(--color-primary-400)] hover:underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          Website
        </a>
      )}
      {github && (
        <a
          href={`https://github.com/${github}`}
          class="text-[var(--color-primary-600)] dark:text-[var(--color-primary-400)] hover:underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          GitHub
        </a>
      )}
      {twitter && (
        <a
          href={`https://twitter.com/${twitter}`}
          class="text-[var(--color-primary-600)] dark:text-[var(--color-primary-400)] hover:underline"
          target="_blank"
          rel="noopener noreferrer"
        >
          Twitter
        </a>
      )}
    </div>
  </div>

  <div class="prose mb-12">
    <Content />
  </div>

  {articles.length > 0 && (
    <section>
      <h2 class="mb-6 text-xl font-semibold text-[var(--color-text-primary)]">
        Articles by {name}
      </h2>
      <div class="space-y-6">
        {articles.map((article) => (
          <ArticleCard
            article={article}
            authorName={authorMap.get(article.data.author.id) ?? 'Unknown'}
          />
        ))}
      </div>
    </section>
  )}
</BaseLayout>
